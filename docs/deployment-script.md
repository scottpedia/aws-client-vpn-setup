# [client-vpn-aio](../client-vpn-aio)

This page explains how to use the script to, create a new OpenVPN server deployment, or manage an existing OpenVPN server deployment.

## On This Page

- [Requirements](#requirements)
- [To Deploy a New OpenVPN server](#to-deploy-a-new-openvpn-server)
- [Deployment Parameters](#deployment-parameters)
- [To Manage an Existing Server Deployment](#to-manage-an-existing-server-deployment)
- [Helper Text](#helper-text)
- [Troubleshooting](#troubleshooting)

## Requirements

- git
- python-boto3
- aws-cli
- python3

Before using this script, please make sure the aws cli is properly configured with your AWS account on your system. To configure aws cli, use the following command:

```shell
$ aws configure
```

## To Deploy a new OpenVPN server

- Clone the repository onto your filesystem.
  ```shell
  $ git clone https://github.com/scottpedia/aws-client-vpn-setup.git
  ```
- Enter the cloned repository.
  ```shell
  $ cd aws-client-vpn-setup
  ```
- Run the script.
  ```shell
  ./client-vpn-aio
  ```
  > **Note:** Be aware that the script will generate a temproray folder under the current working directory during deployment, which is deleted when the process completes. If the deployment is successful, you will also get two output files under CWD. So please make sure that you have the write permission to the current working directory.
- You will be then interactively asked for [the customization parameters](#deployment-parameters) for the VPN server.
- After the deployment completes, you will get two output files under the current working directory.
  - `friendlyName.ovpnsetup` which contains the information of the deployment. It is used by the script to manage a specific deployment.
  - `friendlyName.ovpn` which you use to connect to the server with client software.
  
  To connect to the server, you need to first activate the endpoint and then connect to it using client VPN software, with the `.ovpn` file generated by the script.

## Deployment Parameters

During the deployment process, you will be asked the following customization options for your VPN server, in the order that they are listed.

1. **friendly name of the deployment**, this will be the identifier used by multiple resources on AWS. If left blank, a randomly generated set of characters will be used.

2. **whether to enable [split tunnel](https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/split-tunnel-vpn.html) on your VPN server**. Enable this feature if you want to access network resources inside your **Local Area Network** while connected to the VPN. If left blank, this feature will be disabled by default.

3. **whether to allow intra-subnet communication between connected clients**. If enabled, the clients connected to the endpoint would not be able reach on another via the endpoint subnet. By default, this feature is disabled.

4. **network protocol to use to connect to your VPN server**. Two options are `tcp`, and `udp`. Choose `tcp` for a more stable connection, and choose `udp` for a faster connection. By default, the script will use `udp`.

5. **AWS region** to deploy the VPN server.

6. **review and confirm the parameters**. At this step, press `Enter` to confirm the settings. Press any other key + `Enter` to abort the deployment.

7. **you will be asked permission to download a git repository under the current directory**. Press `Enter` to confirm the action.

## To Manage an Existing Server Deployment

After deploying the server, you can manage it with this script. With the script, you can:
- turn on the server
- shutdown the server
- getting the current status of the server
- toggle the server state(on and off)
- terminate the deployment

**The script needs to know the target deployment that you want to manage.** It does so by looking for the **deployment profile**(`xxx.ovpnsetup`) generated by the script during deployment, under the current working directory. 

With no arguments, the script by default selects the deployment profile found under the current working directory **that was most recently created.**

**Alternatively**, you can manually specify the filename of the deployment profile by using `-f` flag.

```shell
$ ./client-vpn-aio [command] -f /path/to/deployment/profile.ovpnsetup
```

For more information on how to use the script to manage an existing server deployment, please refer to the helper text below.

## Helper Text

```
Usage: ./client-vpn-aio [command] -f [the_config_file]
The python script to deploy and manage the vpn service based on AWS Client VPN Endpoints.

NOTE: PLEASE HAVE YOUR AWS CLI SETUP WITH YOUR AWS ACCOUNT BEFORE YOU RUN THIS SCRIPT.
      THE SCRIPT WILL NOT RUN WITHOUT AN AWS ACCOUNT SETUP WITH THE CLI.

***TO DEPLOY A NEW VPN SERVICE, please run the script without any command.***

***TO MANAGE AN EXISTING ENDPOINT, please use the following commands:***
    status    :   Output the current status of the specified VPN Endpoint.
    on        :   Turn on the VPN
    off       :   Turn off the VPN
    toggle    :   Toggle the VPN
    terminate :   Terminate the selected OVPN setup on AWS.
   *help      :   Output the help

    -f [Filename] (Optional)
    You can use the optional -f flag to specify the file which contains the profile of a specific VPN deployment(*.ovpnsetup).
    Thus you can have multiple deployments active at the same time, and manage each of them with its profile.
    If the file is not speficied, the program will automatically look for one under the current working directory.
    If multiple profiles are found under the CWD, the most recent one will be used.
```

## Troubleshooting

  - `botocore.exceptions.ClientError: An error occurred (UnrecognizedClientException) when calling the ImportCertificate operation: The security token included in the request is invalid.`  
  If you get this error, you are probably trying to deploy the endpoint in a region that is not enabled. Go to your account [page](https://console.aws.amazon.com/billing/home?#/account) and enable the AWS region of your choice under **"AWS Regions"** section. Wait for a few minutes and try again, and you should be able to initiate the deployment at that time.

  - `subprocess.CalledProcessError: Command '['git', 'clone', 'https://github.com/openvpn/easy-rsa.git', '.easy-rsa-XiJ7jjh11b']' returned non-zero exit status 128.`  
    If you get this error, it means that the command to fetch the open-rsa utility failed. There are two possibilities in this case.  

    Check your command output. If you find `fatal: unable to access 'https://github.com/openvpn/easy-rsa.git/': Could not resolve host: github.com`, then it should be your internet connection that caused the problem.

    If you find `git: command not found`, you may not have `git` installed on your system.
